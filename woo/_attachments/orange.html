<!DOCTYPE html>
<html>
  <head>
    <title>Orange Factor</title>
    <link rel="stylesheet" href="style/main.css" type="text/css">
  </head>
  <body>
    <div id="overall"></div>
    <div id="calendar"></div>
    <div id="sidebar">
      <p>Back to <a href="#" onclick="window.location.assign(baseUrl());return false;">overview</a></p>
      <p>Welcome to Orange Factor</p>
      <p>Here we will tell you the chance of getting an orange for any given checkin!</p>
      <p>Our goal is to provide a useful tool for measuring the orange in our trees while 
         finding a quantitative method for measuring if we are improving or degrading over time.
      </p>
      <p>more details: <a href="about.html">about:orangefactor</a></p>
      <p><a href="http://github.com/jmaher/Orange-Factor">code on github</a></a>
    </div>
    <div id="display"></div>
    <div id="placeholder"></div>
    <div id="details"></div>
    <div id="misc"></div>
  </body>

  <script src="vendor/couchapp/loader.js"></script>
  <script src="vendor/couchapp/scripts/jquery.js"></script>
  <script src="vendor/couchapp/scripts/jquery.couch.js"></script>
  <script src="scripts/jquery.flot.min.js"></script>
  <script src="scripts/woo.utils.js"></script>
  <script src="scripts/woo.graphs.js"></script>
  <script src="scripts/woo.calendar.js"></script>
  <script src="scripts/woo.heatmap.js"></script>
  <script type="text/javascript" charset="utf-8">
  var gApp = null;
  var gStartDate = "";
  var gEndDate = "";

  function parseBugs(data) {
    var results = {};
    var dateresults = {};
    var pushresults = {};
    var movingresults = {};
    var movingdays = 7;
    var dr = data["rows"];
    for (row in dr) {
      var r = dr[row];
      var key = r["key"][0];
      if (key == null)
        continue
        
      if (results[key] == null) {
        results[key] = new Array();
      }

      var date = r["value"][1]["date"];
      var parts = date.split('-');
      var d = new Date(parts[0], (parseInt(parts[1], 10) -1), parts[2]);
      var udate = d.getTime();
      results[key].push({"date":date, "udate":udate, "pushcount": r["value"][0], "data":r["value"][1]});
    }
    for (row in results) {
      results[row] = results[row].sort(function(a, b) { return a["udate"] - b["udate"]});
      var datecount = {};
      var pushcount = {};
      for (item in results[row]) {
        var it = results[row][item]
        date = it["udate"];
        if (datecount[date] == null) {
          datecount[date] = 0;
          pushcount[date] = it["pushcount"];
        }
        datecount[date] += 1;
      }
      var dateArray = [];
      var pushArray = [];
      var movingArray = [];
      var movingSum = [];
      var startdate = 0;
      var enddate = 0;
      movingIter = 0;
      for (d in datecount)  {
        if (enddate < d) {
          enddate = d;
        }
        if (startdate <= 0 || startdate > d) {
          startdate = d;
        }
        dateArray.push([d, datecount[d]]);
        pushArray.push([d, datecount[d]/pushcount[d]]);
        movingSum.push(datecount[d]/pushcount[d]);
        if (movingIter >= movingdays) {
          var sum = 0;
          for (var idx = 0; idx < movingSum.length; idx++)
            sum += movingSum[idx];
          
          sum = sum / movingSum.length;
          movingSum.shift();
          movingArray.push([d, sum]);
        }
        movingIter += 1;
      }
      dateresults[row] = dateArray;
      pushresults[row] = pushArray;
      movingresults[row] = movingArray;
    }
    return [results, dateresults, pushresults, movingresults, startdate, enddate];
  }


  function displayDetails(app, data, platform, test, branch, type, startday, endday) {
    var text = '<p><span id="title">';
    text += 'Bugs related to above failures</span></p>';

    var retVal = [];
    var count = 1;
    for (row in data.rows) {      
      var oranges = data.rows[row].value.oranges;
      if (oranges === undefined) {
        oranges = [data.rows[row].value];
      }
      for (orange in oranges) {
        var or = oranges[orange];

        var mplat = false;
        if (platform === undefined || platform == '' || platform == 'All') {
          mplat = true;
        } else if (platform == or.platform) {
          mplat = true;
        }

        var mbranch = false;
        if (branch === undefined || branch == '' || branch == 'All') {
          mbranch = true;
        } else if (branch == or.branch) {
          mbranch = true;
        }

        var mtype = false;
        if (type === undefined || type == '' || type == 'All') {
          mtype = true;
        } else if (type == or.buildtype) {
          mtype = true;
        }

        if (mplat && mbranch && mtype) {
          if (retVal[or.bug] === undefined) {
            retVal[or.bug] = {'summary':or.summary, 'test':or.test, 'count':1};
          } else {
            retVal[or.bug].count += 1;
          }
        }
      }
    }
    
    for (testrun in testruns) {
      if (typeof(testruns[testrun]) != "object") {
        var blob = {};
        blob[testrun] = testruns[testrun];
      } else {
        blob = testruns[testrun];
      }
      for (sub in blob) {
        var title = false;
        for (id in retVal) {
          var bug = retVal[id];
          if (bug.test == blob[sub]) {
            if (!title) {
              title = true;
              text += '<p><span id="bug">' + bug.test + '</span></p>';
            }
            text += '<p><span id="bug"><a href="' + buildUrl('Bug', {bugid: id}) + '">';
            text += id + '</a> (' + bug.count + ') - </span>';
            text += '<span id="summary">' + bug.summary + '</span></p>';
          }
        }
      }
    }
    return text;
  }

  //TODO: consider using range as a filter for startkey/endkey or creating a new view
  function displayMetric(app, id, range) {
    var startdate = buildTboxDate(1970, 01, 01);
    var enddate = getTboxDate();
    app.db.view('woo/date_count',
                {success: function(data) {
                  text = '<span id="overalltitle">';
                  text += 'Overall Orange Factor ' + calculateMetric(data, range)[0];
                  text += '</span>';
                  $(id).html(text);
                },
                startkey: [startdate],
                endkey: [enddate],
                });
  }
  
  function displayBug(app, id, args) {
    var bugid = args['bugid'];
    if (isNaN(parseInt(bugid, 10)))
      return;
    var text = '';
    clearPage();
    text += "<h1>Detail for bug: " + bugid + "</h1>";
    app.db.view('woo/bybug',
                {success: function(data) {
                  var results = parseBugs(data);
                  table = "<table><tr><td>Date</td><td>Platform</td><td>BuildType</td></tr>";
                  for (bug in results[0]) {
                    b = results[0][bug];
                    text += '<span id="bug"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=' + bug + '">' + bug + '</a>, ' + b.length + ' total failures';
                    text += ': </span><span id="summary">';
                    text += b[0].data.summary;
                    text += '</span><p>';
                    for (item in b) {
                      var dat = b[item].data;
                      table += "<tr><td>"+b[item].date + "</td><td>" + dat.platform + "</td><td>" + dat.buildtype + "</td></tr>";
                    }
                  }
                  table += "</table>";
                  $("#display").html(text);
                  showLineGraphMultiple([results[1][bugid], results[2][bugid], results[3][bugid]], ["Bug Frequency (BF)", "Frequency/Pushes per Day (F/P/D)", "7day moving avg of F/P/D"], results[4], results[5]);
                  $("#details").html(table);

                },
                key: [parseInt(bugid, 10)],
                });
  }

  function parseTestRun(data, plat, branch, type) {
    var results = {};
    count = 0;
    for (row in data.rows) {
      r = data.rows[row];
      if (r.key == null) {
        continue;
      }
      
      var mplat = false;
      if (plat == '' || plat == 'All') {
        mplat = true;;
      } else if (plat == r.value.platform) {
        mplat = true;
      }
      
      var mbranch = false;
      if (branch == '' || branch == 'All') {
        mbranch = true;;
      } else if (branch == r.value.branch) {
        mbranch = true;
      }

      var mtype = false;
      if (type == '' || type == 'All') {
        mtype = true;;
      } else if (type == r.value.buildtype) {
        mtype = true;
      }

      if (mplat && mbranch && mtype) {
        if (results[r.key[1]] == null) {
          results[r.key[1]] = new Array();
        }
        results[r.key[1]].push({"date":r.key[0], "data":r.value});
        count++;
      }
    }
    return [results, count];
  }

  function buildDropDown(dataset, index, id, plat, test, branch, btype, startday, endday) {
    var p = "'" + encodeURIComponent(plat) + "'";
    var t = "'" + encodeURIComponent(test) + "'";
    var b = "'" + encodeURIComponent(branch) + "'";
    var type = "'" + encodeURIComponent(btype) + "'";

    if (index == "testrun") {
      index = test;
      t = 'this.options[this.selectedIndex].value';
    } else if (index == "platform") {
      index = plat;
      p = 'this.options[this.selectedIndex].value';
    } else if (index == "branches") {
      index = branch;
      b = 'this.options[this.selectedIndex].value';
    } else if (index == "buildtype") {
      index = btype;
      type = 'this.options[this.selectedIndex].value';
    }

    var args = { plat: p,
                 test: t,
                 branch: b,
                 type: type,
                 startday: "'" + startday + "'",
                 endday: "'" + endday + "'"};

    text = '<select id="testruns" ';
    text += 'onchange="window.location.assign(buildUrl(\'TestRun\', ' +
            displayArgs(args) + '));">';
    text += '<option value="All"';
    if (index == '' || index == 'All') {
      text += ' SELECTED ';
    }
    text += '>All</option>';
    for (t in dataset) {
      if (typeof(dataset[t]) != "object") {
        var blob = {};
        blob[t] = dataset[t];
      } else {
        blob = dataset[t];
      }
      for (sub in blob) {
        text += '<option value="' + blob[sub] + '"';
        if (index == blob[sub]) {
          text += ' SELECTED ';
        }
        text += '>' + blob[sub] + '</option>';
      }
    }
    text += '</select>';
    return text;  
  }

  function displayTestRun(app, id, args) {
      var plat = args['plat'],
          test = args['test'],
          branch = args['branch'],
          type = args['type'],
          startday = args['startday'],
          endday = args['endday'];

      if (startday == "" || startday === undefined) {
        startday = '';
      }
      if (endday == "" || endday === undefined) {
        endday = getTboxDate();
      }
      
      var starttest = test;
      var endtest = test;
      if (test == 'All') starttest = '';
      if (test == 'All') endtest = {};

      app.db.view('woo/bytestrun', 
         {success: function(data) {
            $("#details").html('');
            $("#placeholder").html('');
            results = parseTestRun(data, plat, branch, type);
            dr = getDateRange(data, 1);
            var text = '<span id="title">';
            text += '<form>';
            text += buildDropDown(platforms, "platform", id, plat, test, branch, type, startday, endday);
            text += buildDropDown(buildtypes, "buildtype", id, plat, test, branch, type, startday, endday);
            text += buildDropDown(branches, "branches", id, plat, test, branch, type, startday, endday);
            text += buildDropDown(testruns, "testrun", id, plat, test, branch, type, startday, endday);
            text += "</form>";
            text += '</span><p><span id="subtitle">';
            text += '(' + results[1] + ' failures found ';
            if (dr[0] != dr[1]) {
              text += 'between ' + dr[0]  + ' and ';
            } else {
              text += 'on ';
            }
            text += dr[1] + ')';
            text += '</span><p>';
            
            if (dr[0] != dr[1]) {
              var graphdata = [];
              for (date in results[0]) {
                var parts = date.split('-');
                var d = new Date(parts[0], (parseInt(parts[1], 10) -1), parts[2]);
                graphdata.push([d.getTime(), results[0][date].length]);
              }
              showBarGraph(graphdata, test, plat, startday, endday);
            } else {
              var graphdata = [];
              var dayresults = {};
              for (date in results[0]) {
                for (item in results[0][date]) {
                  var rdata = results[0][date][item].data;
                  if (dayresults[rdata.platform] === undefined) {
                    dayresults[rdata.platform] = 0;
                  }
                  dayresults[rdata.platform] += 1;
                }
              }
              
              for (p in dayresults) {
                graphdata.push([getPlatformAsArray(p)[1], dayresults[p]]);
              }
              showBarGraphDay(graphdata, test, plat, startday, endday);
            }
            $("#details").html(displayDetails(app, data, plat, test, branch, type, startday, endday));
            $(id).html(text);
         },
         startkey: [starttest, startday],
         endkey: [endtest, endday],
         });
  }

  function mapLoaded() {
    return loadSearchQuery(gApp, "#display");
  }

  function displayOverview(app) {
    displayMetric(app, "#overall");
    buildCalendar(app, "#calendar");  
    if (!mapLoaded()) {
      clearPage(true);
      displayHeatMap(app, "#display", {});
    }
  }

  function loadSearchQuery(app, id) {
    var params = document.location.search.slice(1).split("&");
    var display_func = "";
    var args = new Object();
    for (p in params) {
      var l = params[p].split("=").map(function(x)
          { return decodeURIComponent(x); });
      if (l.length != 2)
        continue;
      if (l[0] == "display")
        display_func = "display" + l[1];
      else
        args[l[0]] = l[1];
    }

    if (!display_func || typeof window[display_func] != "function")
      return false;

    window[display_func](app, id, args);
    return true;
 }

  $.couch.app(function(app) {
    gApp = app;
    displayOverview(app);
  });
  </script>
</html>
