<!DOCTYPE html>
<html>
  <head>
    <title>Orange Factor</title>
    <link rel="stylesheet" href="style/main.css" type="text/css">
  </head>
  <body>
    <div id="overall"></div>
    <div id="calendar"></div>
    <div id="sidebar">
      <p>Back to <a href="#" onclick="displayOverview(gApp);return false;">overview</a></p>
      <p>Welcome to Orange Factor</p>
      <p>Here we will tell you the chance of getting an orange for any given checkin!</p>
      <p>Our goal is to provide a useful tool for measuring the orange in our trees while 
         finding a quantitative method for measuring if we are improving or degrading over time.
      </p>
      <p>more details: <a href="about.html">about:orangefactor</a></p>
    </div>
    <div id="display"></div>
    <div id="placeholder"></div>
    <div id="details"></div>
    <div id="misc"></div>
  </body>

  <script src="vendor/couchapp/loader.js"></script>
  <script src="vendor/couchapp/scripts/jquery.js"></script>
  <script src="vendor/couchapp/scripts/jquery.couch.js"></script>
  <script src="scripts/jquery.flot.min.js"></script>
  <script src="scripts/woo.utils.js"></script>
  <script src="scripts/woo.graphs.js"></script>
  <script src="scripts/woo.calendar.js"></script>
  <script src="scripts/woo.heatmap.js"></script>
  <script type="text/javascript" charset="utf-8">
  var gApp = null;
  var gStartDate = "";
  var gEndDate = "";

  function parseBugs(data) {
    results = {};
    for (row in data.rows) {
      r = data.rows[row];
      if (r.key == null)
        continue
        
      if (results[r.key[1]] == null) {
        results[r.key[1]] = new Array();
      }
      results[r.key[1]].push({"date":r.key[0], "data":r.value});
    }
    return results;
  }


  function displayDetails(app, data, platform, test, branch, type, startday, endday) {
    var text = '<p><span id="title">';
    text += 'Bugs related to above failures</span></p>';

    var retVal = [];
    var count = 1;
    for (row in data.rows) {      
      var oranges = data.rows[row].value.oranges;
      if (oranges === undefined) {
        oranges = [data.rows[row].value];
      }
      for (orange in oranges) {
        var or = oranges[orange];

        var mplat = false;
        if (platform === undefined || platform == '' || platform == 'All') {
          mplat = true;;
        } else if (platform == or.platform) {
          mplat = true;
        }

        var mbranch = false;
        if (branch === undefined || branch == '' || branch == 'All') {
          mbranch = true;;
        } else if (branch == or.branch) {
          mbranch = true;
        }

        var mtype = false;
        if (type === undefined || type == '' || type == 'All') {
          mtype = true;;
        } else if (type == or.buildtype) {
          mtype = true;
        }

        if (mplat && mbranch && mtype) {
          if (retVal[or.bug] === undefined) {
            retVal[or.bug] = {'summary':or.summary, 'test':or.test, 'count':1};
          } else {
            retVal[or.bug].count += 1;
          }
        }
      }
    }
    
    for (testrun in testruns) {
      if (typeof(testruns[testrun]) != "object") {
        var blob = {};
        blob[testrun] = testruns[testrun];
      } else {
        blob = testruns[testrun];
      }
      for (sub in blob) {
        var title = false;
        for (id in retVal) {
          var bug = retVal[id];
          if (bug.test == blob[sub]) {
            if (!title) {
              title = true;
              text += '<p><span id="bug">' + bug.test + '</span></p>';
            }
            text += '<p><span id="bug"><a href="#" onclick="displayBug(gApp, \'#display\', '+ id + ');return false;">';
            text += id + '</a> (' + bug.count + ') - </span>';
            text += '<span id="summary">' + bug.summary + '</span></p>';
          }
        }
      }
    }
    return text;
  }

  //TODO: consider using range as a filter for startkey/endkey or creating a new view
  function displayMetric(app, id, range) {
    var startdate = buildTboxDate(1970, 01, 01);
    var enddate = getTboxDate();
    app.db.view('woo/date_count',
                {success: function(data) {
                  text = '<span id="overalltitle">';
                  text += 'Overall Orange Factor ' + calculateMetric(data, range)[0];
                  text += '</span>';
                  $(id).html(text);
                },
                startkey: [startdate],
                endkey: [enddate],
                });
  }
  
  function displayBug(app, id, bugid) {
    var text = '';
    app.db.view('woo/bybug',
                {success: function(data) {
                  var results = parseBugs(data);
                  for (bug in results) {
                    b = results[bug];
                    text += '<span id="bug">' + bug + ': ' + b.length;
                    text += ': </span><span id="summary">';
                    text += b[0].data.summary;
                    text += '</span><p>';
                  }
                  $(id).html(text);
                },
                startkey: [,bugid],
                endkey: [,bugid],
                });
  }

  function parseTestRun(data, plat, branch, type) {
    var results = {};
    count = 0;
    for (row in data.rows) {
      r = data.rows[row];
      if (r.key == null) {
        continue;
      }
      
      var mplat = false;
      if (plat == '' || plat == 'All') {
        mplat = true;;
      } else if (plat == r.value.platform) {
        mplat = true;
      }
      
      var mbranch = false;
      if (branch == '' || branch == 'All') {
        mbranch = true;;
      } else if (branch == r.value.branch) {
        mbranch = true;
      }

      var mtype = false;
      if (type == '' || type == 'All') {
        mtype = true;;
      } else if (type == r.value.buildtype) {
        mtype = true;
      }

      if (mplat && mbranch && mtype) {
        if (results[r.key[1]] == null) {
          results[r.key[1]] = new Array();
        }
        results[r.key[1]].push({"date":r.key[0], "data":r.value});
        count++;
      }
    }
    return [results, count];
  }
  
  function buildDropDown(dataset, index, id, plat, test, branch, btype, startday, endday) {
    var p = '\''+plat+'\'';
    var t = '\''+test+'\'';
    var b = '\''+branch+'\'';
    var type = '\''+btype+'\'';
    
    if (index == "testrun") {
      index = test;
      t = 'this.options[this.selectedIndex].value';
    } else if (index == "platform") {
      index = plat;
      p = 'this.options[this.selectedIndex].value';
    } else if (index == "branches") {
      index = branch;
      b = 'this.options[this.selectedIndex].value';
    } else if (index == "buildtype") {
      index = btype;
      type = 'this.options[this.selectedIndex].value';
    }
  
    text = '<select id="testruns" ';
    text += 'onchange="displayTestRun(gApp,\''+id+'\',';
    text += p+',';
    text += t+',';
    text += b+',';
    text += type+',';
    text += '\''+startday+'\',';
    text += '\''+endday+'\');">';
    text += '<option value="All"';
    if (index == '' || index == 'All') {
      text += ' SELECTED ';
    }
    text += '>All</option>';
    for (t in dataset) {
      if (typeof(dataset[t]) != "object") {
        var blob = {};
        blob[t] = dataset[t];
      } else {
        blob = dataset[t];
      }
      for (sub in blob) {
        text += '<option value="' + blob[sub] + '"';
        if (index == blob[sub]) {
          text += ' SELECTED ';
        }
        text += '>' + blob[sub] + '</option>';
      }
    }
    text += '</select>';
    return text;  
  }

  function displayTestRun(app, id, plat, test, branch, type, startday, endday) {
      if (startday == "" || startday === undefined) {
        startday = '';
      }
      if (endday == "" || endday === undefined) {
        endday = getTboxDate();
      }
      
      var starttest = test;
      var endtest = test;
      if (test == 'All') starttest = '';
      if (test == 'All') endtest = {};

      app.db.view('woo/bytestrun', 
         {success: function(data) {
            $("#details").html('');
            $("#placeholder").html('');
            results = parseTestRun(data, plat, branch, type);
            dr = getDateRange(data, 1);
            var text = '<span id="title">';
            text += '<form>';
            text += buildDropDown(platforms, "platform", id, plat, test, branch, type, startday, endday);
            text += buildDropDown(buildtypes, "buildtype", id, plat, test, branch, type, startday, endday);
            text += buildDropDown(branches, "branches", id, plat, test, branch, type, startday, endday);
            text += buildDropDown(testruns, "testrun", id, plat, test, branch, type, startday, endday);
            text += "</form>";
            text += '</span><p><span id="subtitle">';
            text += '(' + results[1] + ' failures found ';
            if (dr[0] != dr[1]) {
              text += 'between ' + dr[0]  + ' and ';
            } else {
              text += 'on ';
            }
            text += dr[1] + ')';
            text += '</span><p>';
            
            if (dr[0] != dr[1]) {
              var graphdata = [];
              for (date in results[0]) {
                var parts = date.split('-');
                var d = new Date(parts[0], (parseInt(parts[1], 10) -1), parts[2]);
                graphdata.push([d.getTime(), results[0][date].length]);
              }
              showBarGraph(graphdata, test, plat, startday, endday);
            } else {
              var graphdata = [];
              var dayresults = {};
              for (date in results[0]) {
                for (item in results[0][date]) {
                  var rdata = results[0][date][item].data;
                  if (dayresults[rdata.platform] === undefined) {
                    dayresults[rdata.platform] = 0;
                  }
                  dayresults[rdata.platform] += 1;
                }
              }
              
              for (p in dayresults) {
                graphdata.push([getPlatformAsArray(p)[1], dayresults[p]]);
              }
              showBarGraphDay(graphdata, test, plat, startday, endday);
            }
            $("#details").html(displayDetails(app, data, plat, test, branch, type, startday, endday));
            $(id).html(text);
         },
         startkey: [starttest, startday],
         endkey: [endtest, endday],
         });
  }

  function displayOverview(app) {
    clearPage();
    displayMetric(app, "#overall");
    displayHeatMap(app, "#display");
    buildCalendar(app, "#calendar");  
  }

  $.couch.app(function(app) {
    gApp = app;
    displayOverview(app);
  });
  </script>
</html>
